<!DOCTYPE html>

<html>
<head>
  <title>layout.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="catches.html">
                catches.coffee
              </a>
            
              
              <a class="source" href="stakeholder.html">
                stakeholder.coffee
              </a>
            
              
              <a class="source" href="access_control.html">
                access_control.coffee
              </a>
            
              
              <a class="source" href="profile.html">
                profile.coffee
              </a>
            
              
              <a class="source" href="Catch.html">
                Catch.coffee
              </a>
            
              
              <a class="source" href="Stakeholder.html">
                Stakeholder.coffee
              </a>
            
              
              <a class="source" href="slugify.html">
                slugify.coffee
              </a>
            
              
              <a class="source" href="catch.html">
                catch.coffee
              </a>
            
              
              <a class="source" href="catches.html">
                catches.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="layout.html">
                layout.coffee
              </a>
            
              
              <a class="source" href="not-found.html">
                not-found.coffee
              </a>
            
              
              <a class="source" href="profile.html">
                profile.coffee
              </a>
            
              
              <a class="source" href="stakeholder.html">
                stakeholder.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>layout.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>module.<span class="function"><span class="title">exports</span></span> = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  `session.username` is set only if agent is authenticated via Persona. Then it contains a string with users e-mail.

  `session.profile` is set only if agent is authenticated and has a profile (stakeholder document). Then it's an object with profile data, i.e. at least
  
      * email (same as username),
      * name (public name),
      * and slug (public identifier used in urls).
  
  There may be other data.</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1>#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> <span class="property">@session</span>?.username?  <span class="keyword">then</span> <span class="property">@username</span>  = <span class="property">@session</span>.username
  <span class="keyword">if</span> <span class="property">@session</span>?.profile?   <span class="keyword">then</span> <span class="property">@profile</span>   = <span class="property">@session</span>.profile</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h1>#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  The rest <span class="keyword">is</span> [html as coffescript](https:<span class="regexp">//gi</span>thub.com<span class="regexp">/gradus/</span>coffeecup<span class="comment">#coffeecup-).</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h1>#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  doctype <span class="number">5</span>
  html -&gt;
    head -&gt;
      title <span class="string">"Uvaga ! "</span> + <span class="property">@title</span> <span class="keyword">or</span> <span class="string">"Hello."</span>
      meta charset: <span class="string">"utf-8"</span>
      meta <span class="string">"http-equiv"</span>: <span class="string">"X-UA-Compatible"</span>, content: <span class="string">"IE=Edge"</span>

      script src: <span class="string">"https://login.persona.org/include.js"</span>

      script src: <span class="string">"http://code.jquery.com/jquery-1.9.1.min.js"</span>
      script src: <span class="string">"http://code.jquery.com/jquery-migrate-1.1.1.min.js"</span>
      script src: <span class="string">"http://code.jquery.com/ui/1.10.3/jquery-ui.js"</span>
      link  href: <span class="string">"http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"</span>, rel: <span class="string">"stylesheet"</span>, type: <span class="string">"text/css"</span>

    body <span class="string">"data-username"</span>: <span class="property">@username</span>, -&gt;
      header -&gt;
        h1 <span class="string">"Uvaga!"</span>
        h2 <span class="string">"Synergy stimulant for the masses."</span>
        <span class="keyword">unless</span> <span class="property">@username</span>
          p -&gt; 
            text <span class="string">"You are annonymous to us. You may "</span>
            a {
              id: <span class="string">"signin"</span>
              <span class="string">"data-signin"</span>: <span class="literal">true</span>
              href: <span class="string">"#"</span>
              class: <span class="string">"persona-button dark"</span>
            }, -&gt;  span <span class="string">"introduce yourself"</span>
            text <span class="string">" at any time."</span>
        <span class="keyword">else</span>
          p -&gt;
            text <span class="string">"We know who you are. You are "</span>
            <span class="keyword">if</span> <span class="property">@profile</span>?
              a href: <span class="string">"/stakeholders/<span class="subst">#{@profile.slug}</span>"</span>, <span class="property">@profile</span>.name
            <span class="keyword">else</span> text <span class="property">@username</span>
            text <span class="string">"! Would you rather "</span>
            a {
              id: <span class="string">"signout"</span>
              <span class="string">"data-signout"</span>: <span class="literal">true</span>
              href: <span class="string">"#"</span>
              class: <span class="string">"persona-button blue"</span>
            }, -&gt;  span <span class="string">"stay annonymous"</span>
            text <span class="string">"?"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>a {
  id: &quot;profile&quot;
  class: &quot;button blue&quot;
  href: &quot;/profile&quot;
}, @user?.name ? &quot;utw√≥rz profil&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      section id: <span class="string">"main"</span>, -&gt;
        <span class="keyword">do</span> content

      footer -&gt;
        p <span class="string">"A footy footer is here"</span>

      coffeescript -&gt;
        ($ document).ready -&gt;
          username = ($ <span class="string">"body"</span>).data <span class="string">"username"</span> ? <span class="literal">null</span>
          <span class="keyword">if</span> username <span class="keyword">then</span> console.log <span class="string">"Logged in as <span class="subst">#{username}</span>"</span>
          <span class="keyword">else</span> console.log <span class="string">"Not logged in (yet?)"</span>

          navigator.id.watch {
            loggedInUser: username
            onlogin     : (assertion) -&gt;
              console.log <span class="string">"Logging in..."</span>
              $.ajax {
                type  : <span class="string">"POST"</span>
                url   : <span class="string">"/auth/login"</span>
                data  : 
                  assertion : assertion
                success : -&gt; <span class="keyword">do</span> window.location.reload
                error   : (xhr, status, error) -&gt; 
                  console.dir xhr
                  <span class="keyword">do</span> navigator.id.logout
              }
            onlogout    : -&gt;
              console.log <span class="string">"Logging out..."</span>
              $.ajax {
                type  : <span class="string">"POST"</span>
                url   : <span class="string">"/auth/logout"</span>
                success : -&gt; <span class="keyword">do</span> window.location.reload
                error   : (xhr, status, error) -&gt; console.error <span class="string">"Logout failed: <span class="subst">#{error}</span>"</span>
              }
          }

          ($ <span class="string">"a[data-signin]"</span>).click  -&gt; <span class="keyword">do</span> navigator.id.request
          ($ <span class="string">"a[data-signout]"</span>).click -&gt; <span class="keyword">do</span> navigator.id.logout</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
